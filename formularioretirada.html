<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Retirada de Equipamentos</title>
    <!-- Bibliotecas externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #4a6bff;
            --primary-hover: #3a56d4;
            --background: #121212;
            --surface: #1e1e1e;
            --surface-light: #2a2a2a;
            --text: #e0e0e0;
            --text-secondary: #b0b0b0;
            --error: #ff4a4a;
            --success: #4caf50;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, -apple-system, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: var(--text);
            background-color: var(--background);
        }
        
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        .client-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: var(--surface-light);
            border-radius: 8px;
            gap: 15px;
        }
        
        .client-info-item {
            flex: 1;
        }
        
        .form-container {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .form-group:focus-within {
            transform: translateY(-2px);
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }
        
        .required {
            color: var(--error);
            margin-left: 4px;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #333;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: var(--surface-light);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 107, 255, 0.2);
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        .radio-group {
            margin: 1rem 0;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-option:hover {
            color: var(--primary);
        }
        
        .other-specify {
            margin-left: 28px;
            margin-top: 8px;
            display: none;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 1rem;
        }
        
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .thank-you {
            display: none;
            text-align: center;
            padding: 3rem;
            background-color: var(--surface);
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .thank-you h2 {
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .thank-you p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .success-icon {
            font-size: 3rem;
            color: var(--success);
            margin-bottom: 1.5rem;
            animation: bounce 0.8s;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }
        
        /* Responsividade */
        @media (max-width: 600px) {
            .client-info {
                flex-direction: column;
            }
            
            .form-container {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>FORMULÁRIO DE RETIRADA DE EQUIPAMENTOS</h1>
        
        <div class="client-info">
            <div class="client-info-item">
                <label for="clienteId">ID do Cliente <span class="required">*</span></label>
                <input type="text" id="clienteId" name="clienteId" required>
            </div>
            <div class="client-info-item">
                <label for="dataRetirada">Data <span class="required">*</span></label>
                <input type="date" id="dataRetirada" name="dataRetirada" required>
            </div>
        </div>
        
        <form id="retiradaForm">
            <!-- Seções do formulário mantidas como no original -->
            <!-- ... -->
            
            <button type="submit" id="submitBtn">
                <span id="btnText">Enviar Formulário</span>
            </button>
        </form>
    </div>
    
    <div id="thankYou" class="thank-you">
        <div class="success-icon">✓</div>
        <h2>Formulário enviado com sucesso!</h2>
        <p>O PDF foi gerado e deve ter iniciado o download automaticamente.</p>
        <p id="pdfViewLink" style="margin-top: 15px;"></p>
    </div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('retiradaForm');
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const thankYou = document.getElementById('thankYou');
            const pdfViewLink = document.getElementById('pdfViewLink');
            
            // Configurar data atual como padrão
            const dataInput = document.getElementById('dataRetirada');
            const today = new Date().toISOString().split('T')[0];
            dataInput.value = today;
            
            // Mostrar campos condicionais
            document.getElementById('motivo8').addEventListener('change', function() {
                document.getElementById('outrosMotivo').style.display = this.checked ? 'block' : 'none';
                if (!this.checked) document.getElementById('outrosMotivoText').value = '';
            });
            
            document.getElementById('troca1').addEventListener('change', function() {
                document.getElementById('nomeProvedorGroup').style.display = this.checked ? 'block' : 'none';
                if (!this.checked) document.getElementById('nomeProvedor').value = '';
            });
            
            // Validação em tempo real
            form.addEventListener('input', function(e) {
                const input = e.target;
                if (input.required && !input.value) {
                    input.style.borderColor = 'var(--error)';
                } else {
                    input.style.borderColor = '#333';
                }
            });
            
            // Função para carregar imagem (para o logo)
            function loadImage(url) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = url;
                });
            }
            
            // Função para gerar PDF com todas as melhorias
            async function gerarPDF(formData) {
                const doc = new jsPDF();
                
                // Configurações iniciais
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                let yPos = 20;
                
                // Adicionar logo (opcional - substitua pela URL do seu logo)
                try {
                    const logo = await loadImage('https://via.placeholder.com/150x50?text=LOGO');
                    doc.addImage(logo, 'JPEG', margin, yPos, 40, 15);
                    yPos += 25;
                } catch (e) {
                    console.log("Logo não carregado, continuando sem ele");
                }
                
                // Cabeçalho
                doc.setFontSize(18);
                doc.setTextColor(74, 107, 255);
                doc.text('FORMULÁRIO DE RETIRADA DE EQUIPAMENTOS', pageWidth / 2, yPos, { align: 'center' });
                yPos += 20;
                
                // Linha divisória
                doc.setDrawColor(74, 107, 255);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 15;
                
                // Informações do cliente
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('INFORMAÇÕES DO CLIENTE', margin, yPos);
                yPos += 10;
                doc.setFont(undefined, 'normal');
                
                doc.text(`• ID do Cliente: ${formData.clienteId}`, margin, yPos);
                yPos += 7;
                doc.text(`• Data: ${new Date(formData.dataRetirada).toLocaleDateString('pt-BR')}`, margin, yPos);
                yPos += 15;
                
                // Dados do formulário
                doc.setFont(undefined, 'bold');
                doc.text('DADOS DA RETIRADA', margin, yPos);
                yPos += 10;
                doc.setFont(undefined, 'normal');
                
                // Função auxiliar para adicionar itens com quebra de linha automática
                const addFormItem = (label, value) => {
                    const text = `• ${label}: ${value || 'Não informado'}`;
                    const lines = doc.splitTextToSize(text, pageWidth - 2 * margin);
                    doc.text(lines, margin, yPos);
                    yPos += 7 * lines.length;
                };
                
                addFormItem('Motivo do cancelamento', `${formData.motivo}${formData.outrosMotivo ? ' (' + formData.outrosMotivo + ')' : ''}`);
                addFormItem('Mudança de endereço/cidade', formData.mudanca);
                
                if (formData.troca === 'Sim') {
                    addFormItem('Troca de provedor', `Sim - ${formData.nomeProvedor}`);
                } else {
                    addFormItem('Troca de provedor', formData.troca);
                }
                
                addFormItem('Expectativas em relação ao serviço', formData.expectativa);
                addFormItem('Dificuldades técnicas', formData.dificuldade);
                
                if (formData.observacoes) {
                    addFormItem('Observações adicionais', formData.observacoes);
                }
                
                yPos += 10;
                
                // Atendente
                doc.text(`• Atendente: ${formData.atendente}`, margin, yPos);
                yPos += 20;
                
                // Rodapé
                doc.setFontSize(8);
                doc.text(`Documento gerado em ${new Date().toLocaleString('pt-BR')} • Página 1/1`, 
                         pageWidth / 2, 287, { align: 'center' });
                
                return doc;
            }
            
            // Envio do formulário
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validar campos obrigatórios
                let isValid = true;
                const requiredInputs = form.querySelectorAll('[required]');
                
                requiredInputs.forEach(input => {
                    if (!input.value) {
                        input.style.borderColor = 'var(--error)';
                        isValid = false;
                    }
                });
                
                if (!isValid) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }
                
                try {
                    // Atualizar UI para estado de carregamento
                    submitBtn.disabled = true;
                    btnText.innerHTML = '<span class="loading-spinner"></span> Gerando PDF...';
                    
                    // Coletar todos os dados do formulário
                    const formData = {
                        clienteId: document.getElementById('clienteId').value,
                        dataRetirada: document.getElementById('dataRetirada').value,
                        motivo: document.querySelector('input[name="motivo"]:checked')?.value,
                        outrosMotivo: document.getElementById('outrosMotivoText').value,
                        mudanca: document.querySelector('input[name="mudanca"]:checked')?.value,
                        troca: document.querySelector('input[name="troca"]:checked')?.value,
                        nomeProvedor: document.getElementById('nomeProvedor').value,
                        expectativa: document.querySelector('input[name="expectativa"]:checked')?.value,
                        dificuldade: document.querySelector('input[name="dificuldade"]:checked')?.value,
                        observacoes: document.getElementById('observacoes').value,
                        atendente: document.getElementById('atendente').value
                    };
                    
                    // Gerar PDF
                    const pdf = await gerarPDF(formData);
                    
                    // Criar nome do arquivo
                    const fileName = `Retirada_${formData.clienteId}_${new Date().toISOString().split('T')[0]}.pdf`;
                    
                    // Opção 1: Baixar automaticamente
                    pdf.save(fileName);
                    
                    // Opção 2: Visualizar antes de baixar (descomente as linhas abaixo)
                    // const pdfBlob = pdf.output('blob');
                    // const pdfUrl = URL.createObjectURL(pdfBlob);
                    // pdfViewLink.innerHTML = `<a href="${pdfUrl}" target="_blank">Abrir PDF em nova aba</a>`;
                    
                    // Mostrar mensagem de sucesso
                    form.style.display = 'none';
                    thankYou.style.display = 'block';
                    thankYou.scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    alert('Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.\n\nDetalhes: ' + error.message);
                } finally {
                    // Resetar o botão
                    submitBtn.disabled = false;
                    btnText.textContent = 'Enviar Formulário';
                    
                    // Resetar o formulário após 10 segundos
                    setTimeout(() => {
                        form.reset();
                        dataInput.value = today;
                        form.style.display = 'block';
                        thankYou.style.display = 'none';
                    }, 10000);
                }
            });
        });
    </script>
</body>
</html>
